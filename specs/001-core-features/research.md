# 調査: コア機能

**ブランチ**: `001-core-features` | **日付**: 2026-02-19
**ステータス**: 解決済み

## 1. 永続化戦略 (Persistence)

*   **決定**: `stdpath('data')/marginalia/annotations.json` にJSONファイルを保存。
*   **理由**:
    *   `vim.json` は高速で組み込まれている。
    *   デバッグ時に人間が読みやすい。
    *   `stdpath('data')` はプラグインデータのための標準的な場所である。
*   **検討した代替案**:
    *   `sqlite.lua`: 外部バイナリ依存のため却下 (憲章Vに違反)。
    *   `vim.g` / `shada`: 構造化データの管理が複雑であり、フックなしではデフォルトで永続化されないため却下。
    *   `PStore` (独自バイナリ): 過剰。

## 2. 入力インターフェース (UI)

*   **決定**: フローティングウィンドウ（バッファ）を使用。
*   **理由**:
    *   **複数行入力**: `vim.ui.input` は基本的に1行入力のため、詳細なコメント記述には不十分（仕様変更 FR-003）。
    *   **Vim Native Workflow**: バッファとして扱うことで、強力な編集機能と標準的なキーバインド（`:w` で確定、`:q!` でキャンセル）を利用可能。
    *   管理画面（User Story 4）との一貫性。
*   **検討した代替案**:
    *   `vim.ui.input`: 1行制限があり、複数行には不向き。
    *   `input()`: 同上。ブロッキングする。

## 3. プロジェクトルート検出 (Utils)

*   **決定**: `vim.fs.find` (Neovimネイティブ) を使用し、`plenary.path` をフォールバックとする。
*   **理由**:
    *   `vim.fs` は0.9.0以降で利用可能。
    *   `.git` マーカーの検出をネイティブでサポート。
*   **検討した代替案**:
    *   `lspconfig.util`: LSP設定への依存を避けるため却下。
    *   手動ループ: `vim.fs` の方が優れている。

## 4. テストインフラ (Testing)

*   **決定**: `plenary.nvim` (busted) と `minimal_init.lua`。
*   **理由**:
    *   Neovimプラグインにおけるデファクトスタンダード。
    *   非同期テストをサポート。
    *   CIとの統合が容易。
    *   **テストファースト戦略**: モジュールの実装前に `tests/marginalia` のスペックファイルを作成します。
*   **検討した代替案**:
    *   `vusted`: 良いが、`plenary` はおそらく他のユーティリティでも依存関係として必要になる。
    *   レガシーなVimscriptテスト: 却下 (憲章V)。

## 5. クリップボード統合

*   **決定**: 設定に基づき `+` または `*` レジスタを使った `vim.fn.setreg`。
*   **理由**: ネイティブVim APIを使用し、クリップボードプロバイダが存在すれば機能する。
